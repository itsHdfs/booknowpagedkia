<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DKUALAEXPRESS+ Elite</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
body{background:#111;color:#fff;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;}
.container{background:#1a1a1a;border-radius:20px;padding:30px;max-width:500px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,0.7);}
h2{color:#d4af37;margin-bottom:20px;font-size:1.6rem;text-align:center;}
input, select{width:100%;padding:15px;margin:10px 0;border-radius:12px;border:2px solid #d4af37;background:#222;color:#fff;font-size:1rem;}
button{width:100%;padding:18px;margin-top:15px;border-radius:12px;border:none;background:linear-gradient(90deg,#d4af37,#a8b77e);color:#111;font-size:1.2rem;font-weight:700;cursor:pointer;transition:transform 0.2s, box-shadow 0.2s;}
button:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(212,175,55,0.7);}
h1.bookingCode{color:#d4af37;font-size:2rem;text-align:center;margin:20px 0;}
table {width: 100%; border-collapse: separate; border-spacing: 0; border: 2px solid #d4af37; border-radius: 15px; overflow: hidden; margin-top: 15px; background:#222; box-shadow: 0 5px 15px rgba(212,175,55,0.5);}
th, td {padding: 12px; text-align: center; border-bottom: 1px solid #d4af37;}
th {background: #333; font-weight: 700;}
tr:last-child td {border-bottom: none;}
button.pickCar {background: linear-gradient(90deg,#d4af37,#a8b77e);color:#111;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:700;}
button.pickCar:hover {transform: translateY(-2px);box-shadow:0 5px 15px rgba(212,175,55,0.5);}
#loadingScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:#111;display:flex;justify-content:center;align-items:center;flex-direction:column;color:#d4af37;font-weight:900;z-index:1000;}
.loader{border:12px solid #333;border-top:12px solid #d4af37;border-radius:50%;width:120px;height:120px;background: linear-gradient(45deg, #d4af37, #ffeaa7, #ffd700, #d4af37);background-size:400% 400%;animation:spin 1s linear infinite, gradientShift 2.5s ease infinite;margin-bottom:20px;}
.loader-text{font-size:2.5rem;text-align:center;letter-spacing:2px;animation:glow 1.5s infinite alternate, floatText 2s ease-in-out infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
@keyframes gradientShift{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
@keyframes glow{0%{text-shadow:0 0 10px #d4af37,0 0 20px #ffd700;}100%{text-shadow:0 0 25px #ffd700,0 0 50px #fff59d;}}
@keyframes floatText{0%{transform:translateY(0);}50%{transform:translateY(-10px);}100%{transform:translateY(0);}}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
<div id="loadingScreen">
  <div class="loader"></div>
  <div class="loader-text">MYKUALAEXPRESS+</div>
</div>

<div id="mainApp" style="display:none;">
  <!-- Book Now -->
  <div class="container" id="bookNowScreen">
    <h2>MYKUALAEXPRESS+</h2>
    <h2>Book Your Ride</h2>
    <form id="bookForm">
      <select name="title" required>
        <option value="">Your title</option>
        <option>Mr.</option>
        <option>Ms.</option>
        <option>Mrs.</option>
        <option>Miss.</option>
      </select>
      <input type="text" name="fullName" placeholder="Full name" required>
      <input type="date" name="dob" required max="2013-12-31">
      <input type="text" name="ic" placeholder="IC Numb." required readonly>
      <input type="tel" name="phone" placeholder="Phone" required>
      <input type="email" name="email" placeholder="Email" required>
      <button type="submit">Next</button>
    </form>
  </div>

  <!-- Find Cars -->
  <div class="container" id="findCarsScreen" style="display:none;">
    <h2>Find Your Car</h2>
    <form id="searchForm">
      <select name="from" required>
        <option value="">Dari</option>
        <option>Kuala</option>
        <option>Binsulok</option>
        <option>Likas</option>
        <option>Membakut</option>
        <option>Kuala Penyu</option>
      </select>
      <select name="to" required>
        <option value="">Ke</option>
        <option>Kuala</option>
        <option>Binsulok</option>
        <option>Likas</option>
        <option>Membakut</option>
        <option>Kuala Penyu</option>
      </select>
      <button type="submit">Search Cars</button>
    </form>
    <table>
      <thead>
        <tr><th>Car Type</th><th>Plat Numb.</th><th>Date & Time</th><th>From</th><th>To</th><th>Price MYR</th><th>Action</th></tr>
      </thead>
      <tbody id="carTableBody"></tbody>
    </table>
    <button onclick="showScreen('bookNowScreen')">Back</button>
  </div>

  <!-- Confirm -->
  <div class="container" id="confirmScreen" style="display:none;">
    <h2>Confirm Your Booking</h2>
    <div id="confirmDetails"></div>
    <button id="confirmBtn">Confirm</button>
    <button onclick="showScreen('findCarsScreen')">Cancel</button>
  </div>

  <!-- Pre-Payment -->
  <div class="container" id="prePaymentScreen" style="display:none;">
    <h2>Your Booking Code</h2>
    <h1 class="bookingCode" id="bookingCodeDisplay"></h1>
    <p style="text-align:center;">For safety, please save or screenshot this Booking Code</p>
    <p style="text-align:center;">Redirecting to home in 20 seconds...</p>
  </div>
</div>

<script>
const firebaseConfig = { apiKey:"AIzaSyDcAq_rnJ3342lCpxalebddMFGDFUrypUg", authDomain:"aeris-data-smkmii.firebaseapp.com", projectId:"aeris-data-smkmii" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const loadingScreen = document.getElementById('loadingScreen');
const mainApp = document.getElementById('mainApp');
const bookForm = document.getElementById('bookForm');
const bookNowScreen = document.getElementById('bookNowScreen');
const findCarsScreen = document.getElementById('findCarsScreen');
const confirmScreen = document.getElementById('confirmScreen');
const prePaymentScreen = document.getElementById('prePaymentScreen');
const carTableBody = document.getElementById('carTableBody');
const confirmDetails = document.getElementById('confirmDetails');
const bookingCodeDisplay = document.getElementById('bookingCodeDisplay');

let bookingData = {};

window.addEventListener('load', ()=>{
  loadingScreen.style.display='flex';
  setTimeout(()=>{ loadingScreen.style.display='none'; mainApp.style.display='block'; },1500);
});

function showScreen(id){
  bookNowScreen.style.display='none';
  findCarsScreen.style.display='none';
  confirmScreen.style.display='none';
  prePaymentScreen.style.display='none';
  document.getElementById(id).style.display='block';
}

// DOB → IC auto
dobInput = bookForm.querySelector('[name="dob"]');
icInput = bookForm.querySelector('[name="ic"]');
dobInput.addEventListener('change', ()=>{
  const dob = new Date(dobInput.value);
  if(dob.toString()!=='Invalid Date'){
    const yy = String(dob.getFullYear()).slice(2);
    const mm = String(dob.getMonth()+1).padStart(2,'0');
    const dd = String(dob.getDate()).padStart(2,'0');
    icInput.value = `${yy}/${mm}/${dd} XXXXXX`;
  }
});

// Book Form Submit (12+ only)
bookForm.addEventListener('submit', e=>{
  e.preventDefault();
  const dob = new Date(bookForm.dob.value);
  if(dob.getFullYear() > 2013){ alert("You must be 12 years old or above."); return; }
  bookingData = Object.fromEntries(new FormData(bookForm));
  showScreen('findCarsScreen');
});

// Search Cars
const searchForm = document.getElementById('searchForm');
searchForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const searchData = Object.fromEntries(new FormData(searchForm));
  if(searchData.from===searchData.to){ alert('From & To cannot be same!'); return; }

  bookingData.from = searchData.from;
  bookingData.to = searchData.to;

  showLoadingScreen();
  await loadCarsFromFirebase();
  hideLoadingScreen();
});

function showLoadingScreen(){ loadingScreen.style.display='flex'; mainApp.style.pointerEvents='none'; setTimeout(()=>{ hideLoadingScreen(); },5000);}
function hideLoadingScreen(){ loadingScreen.style.display='none'; mainApp.style.pointerEvents='auto'; }

// Load cars
async function loadCarsFromFirebase(){
  carTableBody.innerHTML='';
  const snapshot = await db.collection('CarTransitDetails')
    .where('from','==',bookingData.from)
    .where('to','==',bookingData.to)
    .get();

  if(snapshot.empty){
    carTableBody.innerHTML=`<tr><td colspan="7">No transit found</td></tr>`;
    return;
  }

  snapshot.docs.forEach(doc=>{
    const car = doc.data();
    let dateTimeText = '';
    if(car.date && car.date.toDate){
      const d = car.date.toDate();
      dateTimeText = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${car.carModel}</td>
      <td>${car.numberPlate}</td>
      <td>${dateTimeText}</td>
      <td>${car.from}</td>
      <td>${car.to}</td>
      <td>${car.price}</td>
      <td><button class="pickCar" onclick="selectCar('${doc.id}')">Choose</button></td>
    `;
    carTableBody.appendChild(tr);
  });
}

// Select Car
async function selectCar(carId){
  showLoadingScreen();
  const doc = await db.collection('CarTransitDetails').doc(carId).get();
  bookingData.selectedCar = doc.data();
  hideLoadingScreen();
  loadConfirmScreen();
}

// Confirm Screen
function loadConfirmScreen(){
  const car = bookingData.selectedCar;
  const travelDateText = car.date?.toDate ? new Date(car.date.toDate()).toLocaleString() : '';
  confirmDetails.innerHTML=`
    <p>Name: ${bookingData.fullName}</p>
    <p>IC Numb.: ${bookingData.ic}</p>
    <p>Phone: ${bookingData.phone}</p>
    <p>Email: ${bookingData.email}</p>
    <p>Car: ${car.carModel} (${car.numberPlate})</p>
    <p>Driver: ${car.driver}</p>
    <p>From: ${car.from} → ${car.to}</p>
    <p>Price (MYR): ${car.price}</p>
    <p>Date & Time: ${travelDateText}</p>
  `;
  showScreen('confirmScreen');
}

// Booking
function generateBookingCode(){ return `MYKE-${Math.floor(1000 + Math.random()*9000)}`; }

document.getElementById('confirmBtn').addEventListener('click', async ()=>{
  showLoadingScreen();
  bookingData.bookingCode = generateBookingCode();

  await db.collection('Bookings').add({
  userInfo: { ...bookingData },
  selectedCar: { ...bookingData.selectedCar },
  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
  paymentStatus: false,   // boleh terus boolean
  bookingCode: bookingData.bookingCode,
  checkin: false          // <--- boolean check-in default
});

  hideLoadingScreen();
  bookingCodeDisplay.textContent = bookingData.bookingCode;
  showScreen('prePaymentScreen');
  setTimeout(()=>{ window.location.href='https://www.mykualaexpress.com'; },20000);
});
</script>
</body>
</html>
